cmake_minimum_required(VERSION 3.11)

project(ErwanTools)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ============================================================================
# RPATH Configuration - Make plugins portable
# ============================================================================
# Don't set RPATH - rely on Nuke's LD_LIBRARY_PATH environment
# This makes the plugins work regardless of where Nuke is installed
set(CMAKE_SKIP_BUILD_RPATH TRUE)
set(CMAKE_SKIP_INSTALL_RPATH TRUE)

# Set Nuke version and directory (allow override via -DNUKE_VERSION)
if(NOT DEFINED NUKE_VERSION)
    set(NUKE_VERSION "16.0v6")
endif()
set(NDKDIR /opt/Nuke${NUKE_VERSION})

message(STATUS "Nuke Version: ${NUKE_VERSION}")
message(STATUS "Nuke Directory: ${NDKDIR}")

# Verify Nuke directory exists
if(NOT EXISTS ${NDKDIR})
    message(FATAL_ERROR "Nuke directory not found: ${NDKDIR}")
endif()
if(NOT EXISTS ${NDKDIR}/libDDImage.so)
    message(FATAL_ERROR "libDDImage.so not found in: ${NDKDIR}")
endif()

# Add the Nuke include directory
include_directories(${NDKDIR}/include)

# Uncomment the following if needed for compatibility
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D_GLIBCXX_USE_CXX11_ABI=0")
add_compile_options(-fPIC)

# Set the prefix for shared libraries
set(CMAKE_SHARED_LIBRARY_PREFIX "")

# List of source files for each tool
set(SOURCE_FILES 
    src/ChannelFlood.cpp
    src/CopyBBox.cpp
    src/CurveRenderer.cpp
    src/CustomSaturation.cpp
    src/LayerRenamer.cpp
    src/NoBlackOutside.cpp
    src/PixelSort.cpp
    src/WildcardCopy.cpp
    src/WildcardRemoveChannels.cpp
)

# Create each shared library from the corresponding .cpp file
foreach(SRC_FILE ${SOURCE_FILES})
    get_filename_component(LIB_NAME ${SRC_FILE} NAME_WE)

    # Add a shared library for each source file
    add_library(${LIB_NAME} SHARED ${SRC_FILE})

    # Link the necessary libraries
    target_link_libraries(${LIB_NAME} PRIVATE ${NDKDIR}/libDDImage.so OpenGL)

    # No RPATH needed - Nuke's environment provides library paths
    # Install each shared library
    install(TARGETS ${LIB_NAME} DESTINATION ${CMAKE_INSTALL_PREFIX})
endforeach()

# Build summary
message(STATUS "========================================")
message(STATUS "Build Configuration Summary:")
message(STATUS "  Plugins: ${SOURCE_FILES}")
message(STATUS "  Nuke Version: ${NUKE_VERSION}")
message(STATUS "  Nuke Directory: ${NDKDIR}")
message(STATUS "  RPATH: Not set (portable - uses Nuke's environment)")
message(STATUS "  Install Prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "========================================")
